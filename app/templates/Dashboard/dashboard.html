{% extends "base.html" %}
{% block title %}Dashboard - Simvest{% endblock %}

{% block content %}
<div class="flex min-h-screen bg-gray-50 dark:bg-gray-900">
  <!-- Sidebar -->
  <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 shadow-lg border-r border-gray-200 dark:border-gray-700 block transition-all duration-300">
    <div class="p-6">
      <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Panel de Control</h2>
      <nav class="space-y-2">
        <a href="{{ url_for('dashboard.dashboard') }}" class="flex items-center px-4 py-2 text-sm font-medium text-simvest-blue bg-blue-50 dark:bg-blue-900/50 rounded-lg">
          <i class="fas fa-tachometer-alt mr-3"></i> Dashboard
        </a>
        <a href="{{ url_for('market.market') }}" class="flex items-center px-4 py-2 text-sm font-medium text-gray-800 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
          <i class="fas fa-chart-line mr-3"></i> Mercado
        </a>
        <a href="{{ url_for('dashboard.history') }}" class="flex items-center px-4 py-2 text-sm font-medium text-gray-800 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
          <i class="fas fa-history mr-3"></i> Historial
        </a>
        <a href="{{ url_for('profile.profile') }}" class="flex items-center px-4 py-2 text-sm font-medium text-gray-800 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
          <i class="fas fa-user mr-3"></i> Perfil
        </a>
      </nav>
    </div>
    <div class="p-6 border-t border-gray-200 dark:border-gray-700">
      <h3 class="text-sm font-semibold text-gray-800 dark:text-white mb-3">M칠tricas R치pidas</h3>
      <div class="space-y-3">
        <div class="flex justify-between">
          <span class="text-sm text-gray-800 dark:text-gray-400">Capital</span>
          <span class="text-sm font-medium text-green-600">{{ current_capital | currency }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-sm text-gray-800 dark:text-gray-400">Portafolio</span>
          <span class="text-sm font-medium text-blue-600" id="sidebar-portfolio">$0.00</span>
        </div>
        <div class="flex justify-between">
          <span class="text-sm text-gray-800 dark:text-gray-400">P&L</span>
          <span class="text-sm font-medium" id="sidebar-pnl">--</span>
        </div>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8">
    <!-- Toggle Sidebar Button -->
    <button onclick="toggleSidebar()" class="lg:hidden fixed top-20 left-4 z-50 bg-blue-600 text-white p-2 rounded-lg shadow-lg">
      <i class="fas fa-bars"></i>
    </button>
    <div class="max-w-7xl mx-auto space-y-8">

    <!-- SECCI칍N 1: Encabezado de Bienvenida -->
    <section class="flex flex-col md:flex-row md:items-center md:justify-between 
                    bg-gradient-to-r from-simvest-blue to-simvest-darkblue 
                    text-white rounded-2xl shadow-lg p-8 relative overflow-hidden">
        <div class="z-10">
            <h1 class="text-4xl font-extrabold mb-2">
                Bienvenido, <span class="text-simvest-yellow">{{ current_user.username }}</span> 游녦
            </h1>
            <p class="text-lg opacity-90">Gestiona tus inversiones, analiza tu portafolio y aprende del mercado.</p>
        </div>
    </section>

    <!-- SECCI칍N 2: Tarjetas de Resumen (KPIs) -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Capital Disponible -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-2xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold opacity-90">Capital Disponible</h3>
                    <p class="text-3xl font-bold mt-2">{{ current_capital | currency }}</p>
                </div>
                <i class="fas fa-wallet text-4xl opacity-80"></i>
            </div>
        </div>

        <!-- Valor del Portafolio -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-2xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold opacity-90">Valor Portafolio</h3>
                    <div id="loader-portfolio" class="animate-pulse h-8 w-24 bg-white/20 rounded mt-2"></div>
                    <p id="val-portfolio" class="text-3xl font-bold mt-2 hidden">$0.00</p>
                </div>
                <i class="fas fa-chart-line text-4xl opacity-80"></i>
            </div>
        </div>

        <!-- Capital Total -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-2xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold opacity-90">Capital Total</h3>
                    <div id="loader-total" class="animate-pulse h-8 w-24 bg-white/20 rounded mt-2"></div>
                    <p id="val-total" class="text-3xl font-bold mt-2 hidden">$0.00</p>
                </div>
                <i class="fas fa-piggy-bank text-4xl opacity-80"></i>
            </div>
        </div>

        <!-- P&L -->
        <div class="bg-gradient-to-br from-orange-500 to-red-500 p-6 rounded-2xl shadow-lg text-white">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold opacity-90">P&L Global</h3>
                    <p id="val-pnl-pct" class="text-2xl font-bold mt-2 hidden">--</p>
                </div>
                <i class="fas fa-percentage text-4xl opacity-80"></i>
            </div>
        </div>
    </section>
    
    <!-- SECCI칍N 3: Gr치fico de Evoluci칩n -->
    <section class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl border border-gray-100 dark:border-gray-700">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Evoluci칩n del Portafolio</h2>
                <p class="text-gray-800 dark:text-gray-400 mt-1">Rendimiento hist칩rico y tendencias de mercado</p>
            </div>
            <div class="flex items-center space-x-3">
                <button onclick="openChartModal()" class="p-3 text-gray-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-xl transition-all duration-200" title="Vista completa">
                    <i class="fas fa-expand text-lg"></i>
                </button>
            </div>
        </div>

        <!-- Botones de Rango de Tiempo -->
        <div class="flex space-x-3 mb-6 overflow-x-auto">
            {% for tf in ['1D', '1S', '1M', '3M', '1A', 'Todo'] %}
            <button data-timeframe="{{ tf }}"
                    class="timeframe-btn px-4 py-2 text-sm font-medium rounded-xl border-2 transition-all duration-200 whitespace-nowrap
                           {% if tf == 'Todo' %}bg-blue-600 text-white border-blue-600 shadow-lg{% else %}text-gray-600 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 border-gray-200 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-600 hover:border-blue-300{% endif %}">
                {{ tf }}
            </button>
            {% endfor %}
        </div>
        
        <!-- Loader del Gr치fico -->
        <div id="chart-loader" class="flex flex-col justify-center items-center h-80 bg-gray-50 dark:bg-gray-700 rounded-xl">
            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mb-4"></div>
            <span class="text-gray-500 dark:text-gray-400 font-medium">Analizando datos del mercado...</span>
        </div>
        
        <!-- Contenedor del Gr치fico -->
        <div id="chart-container" class="hidden relative h-80 w-full bg-white dark:bg-gray-800 rounded-xl p-4">
            <canvas id="portfolioChart"></canvas> 
        </div>
    </section>

    <!-- SECCI칍N 4: Historial y Gu칤a -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Historial Reciente -->
        <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-100 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-simvest-blue mb-4">游닆 Historial Reciente</h2>
            
            {% if transaction_history %}
            <div class="space-y-3">
                {% for t in transaction_history %}
                {% set is_sell = t.type == 'SELL' %}
                <div class="flex justify-between items-center p-3 rounded-lg border 
                            {% if is_sell %}bg-red-50 border-red-200{% else %}bg-green-50 border-green-200{% endif %}">
                    
                    <div class="flex items-center space-x-3">
                        <span class="text-xl {% if is_sell %}text-red-500{% else %}text-green-500{% endif %}">
                            {% if is_sell %}游댵{% else %}游댴{% endif %}
                        </span>
                        <div>
                            <p class="font-semibold text-gray-800 dark:text-gray-100">
                                {{ t.type }} {{ "{:,.2f}".format(t.quantity) }}x **{{ t.symbol }}**
                            </p>
                            <p class="text-xs text-gray-500">
                                {{ t.timestamp.strftime('%Y-%m-%d %H:%M') }}
                            </p>
                        </div>
                    </div>
                    
                    <p class="font-bold {% if is_sell %}text-red-600{% else %}text-green-600{% endif %}">
                        {{ (t.price_per_unit * t.quantity) | currency }}
                    </p>
                </div>
                {% endfor %}
            </div>
            <a href="{{ url_for('dashboard.history') }}" class="mt-4 inline-block text-simvest-blue hover:underline">
                Ver historial completo
            </a>
            {% else %}
            <p class="text-gray-500 italic">A칰n no hay transacciones en tu historial.</p>
            {% endif %}
        </div>
        
        <!-- Tarjeta de Gu칤a -->
        <div class="bg-simvest-blue/10 dark:bg-blue-900/50 p-6 rounded-2xl shadow-sm border border-simvest-blue/20 h-fit">
            <h3 class="text-xl font-bold text-simvest-blue dark:text-blue-200 mb-3">游꿉 Gu칤a de Simvest</h3>
            <p class="text-gray-700 dark:text-gray-300 mb-4">
                쮼res nuevo? Aprende a usar la plataforma, a comprar acciones y a interpretar tu portafolio.
            </p>
            <a href="#" class="bg-simvest-blue hover:bg-simvest-darkblue text-white font-semibold py-2 px-4 rounded-lg transition duration-150 block text-center">
                Aprender Ahora
            </a>
        </div>

    </section>

    <!-- SECCI칍N 5: Tabla de Mis Inversiones -->
    <section class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-100 dark:border-gray-700">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Mis Inversiones</h2>
                <p class="text-gray-800 dark:text-gray-400 mt-1">Activos actuales en tu portafolio</p>
            </div>
            <a href="{{ url_for('market.market') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl">
                <i class="fas fa-plus mr-2"></i>Comprar M치s
            </a>
        </div>
        
        {% if holdings %}
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-4 font-semibold text-gray-900 dark:text-white">Activo</th>
                        <th class="px-6 py-4 font-semibold text-gray-900 dark:text-white">Cantidad</th>
                        <th class="px-6 py-4 font-semibold text-gray-900 dark:text-white">Precio Compra</th>
                        <th class="px-6 py-4 font-semibold text-gray-900 dark:text-white">Precio Actual</th>
                        <th class="px-6 py-4 font-semibold text-gray-900 dark:text-white">Ganancia/P칠rdida</th>
                        <th class="px-6 py-4 font-semibold text-gray-900 dark:text-white text-center">Valor Total</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200 dark:divide-gray-600">
                    {% for h in holdings %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200 cursor-pointer group" 
                        onclick="window.location='{{ url_for('market.asset_detail', symbol=h.symbol) }}'">
                        
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-chart-line text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-900 dark:text-white group-hover:text-blue-600">{{ h.name }}</div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">{{ h.symbol }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 font-medium text-gray-900 dark:text-white">{{ "{:,.2f}".format(h.quantity) }}</td>
                        <td class="px-6 py-4 text-gray-800 dark:text-gray-300">{{ h.purchase_price | currency }}</td>
                        
                        <td class="px-6 py-4">
                            <span id="price-{{ h.id }}" class="text-gray-400 animate-pulse">Cargando...</span>
                        </td>
                        <td class="px-6 py-4">
                            <span id="gain-{{ h.id }}" class="text-gray-400 animate-pulse">--</span>
                        </td>
                        
                        <td class="px-6 py-4 text-center">
                            <span class="font-semibold text-gray-900 dark:text-white bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-lg">
                                --
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="w-24 h-24 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-chart-line text-4xl text-gray-400"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No tienes inversiones activas</h3>
            <p class="text-gray-800 dark:text-gray-400 mb-6">Comienza tu viaje de inversi칩n explorando el mercado</p>
            <a href="{{ url_for('market.market') }}" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl">
                Explorar Mercado
            </a>
        </div>
        {% endif %}
    </section>

</main>

<!-- MODAL: Gr치fico Expandido (Centrado Corregido) -->
<div id="chart-modal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    
    <!-- 1. Backdrop (Fondo oscuro fijo) -->
    <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeChartModal()"></div>

    <!-- 2. Contenedor de Scroll y Posicionamiento -->
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <!-- Flexbox para centrar contenido vertical y horizontalmente -->
        <div class="flex min-h-screen items-center justify-center p-4"></div>
            
            <!-- 3. La Tarjeta del Modal -->
            <div class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-gray-800 text-left shadow-2xl transition-all sm:my-8 w-full max-w-5xl mx-4">
                
                <!-- Modal Header -->
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-4 sm:px-6 flex justify-between items-center border-b border-gray-100 dark:border-gray-600">
                    <h3 class="text-lg font-bold leading-6 text-gray-900 dark:text-white" id="modal-title">
                        游늵 An치lisis Detallado
                    </h3>
                    <button type="button" class="text-gray-400 hover:text-red-500 hover:bg-gray-100 dark:hover:bg-gray-600 p-1 rounded-full transition focus:outline-none" onclick="closeChartModal()">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Body -->
                <div class="px-4 py-6 sm:px-6 bg-white dark:bg-gray-800">
                    <!-- Contenedor del Gr치fico con altura controlada -->
                    <div class="relative w-full h-[60vh] min-h-[400px]"> 
                        <canvas id="expandedPortfolioChart"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Variables globales
    let smallChartInstance = null;
    let bigChartInstance = null;
    let chartDataCache = null; 
    let activeTimeframe = 'Todo'; // Estado inicial

    // Datos iniciales desde el servidor
    const initialData = {{ initial_data | tojson }};

    // Ruta de la API de datos (debe ser accesible globalmente si es necesario)
    const API_URL = "{{ url_for('dashboard.dashboard_data') }}";

    // --- Funciones del Modal ---
    function openChartModal() {
        const modal = document.getElementById('chart-modal');
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        // Renderizar el gr치fico grande
        if (chartDataCache) {
            if (bigChartInstance) bigChartInstance.destroy();
            
            // Re-renderizamos el grande con los datos actuales
            const ctxBig = document.getElementById('expandedPortfolioChart').getContext('2d');
            bigChartInstance = new Chart(ctxBig, createChartConfig(
                ctxBig, 
                chartDataCache.labels, 
                chartDataCache.values,
                true // isExpanded = true
            ));
        }
    }

    function closeChartModal() {
        const modal = document.getElementById('chart-modal');
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") closeChartModal();
    });

    // --- L칩gica del Gr치fico y Fetch ---

    // Inicializaci칩n del formato de moneda
    const currencyFmt = new Intl.NumberFormat('en-US', {
        style: 'currency', currency: 'USD', minimumFractionDigits: 2
    });

    function formatPnl(pnlVal) {
        const sign = pnlVal >= 0 ? '+' : '';
        const colorClass = pnlVal >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
        return { text: `${sign}${pnlVal.toFixed(2)}%`, colorClass: colorClass };
    }

    function createChartConfig(ctx, labels, values, isExpanded = false) {
        const gradient = ctx.createLinearGradient(0, 0, 0, isExpanded ? 500 : 400); // Ajustar altura
        gradient.addColorStop(0, 'rgba(37, 99, 235, 0.4)'); 
        gradient.addColorStop(1, 'rgba(37, 99, 235, 0.0)'); 

        return {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Valor Total',
                    data: values,
                    fill: true,
                    backgroundColor: gradient,
                    borderColor: '#2563EB',
                    borderWidth: isExpanded ? 3 : 2,
                    pointRadius: 0, 
                    pointHoverRadius: 6, 
                    pointBackgroundColor: '#FFFFFF',
                    pointBorderColor: '#2563EB',
                    pointBorderWidth: 2,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        padding: 12,
                        titleFont: { size: 13 },
                        bodyFont: { size: 14, weight: 'bold' },
                        callbacks: {
                            label: function(context) {
                                return ' ' + currencyFmt.format(context.parsed.y);
                            },
                            title: function(items) {
                                // Muestra el timestamp si estamos en 1D o 1S
                                if (activeTimeframe === '1D' || activeTimeframe === '1S') {
                                    return items[0].label;
                                }
                                // Formatea la fecha de forma m치s limpia para rangos largos
                                const date = new Date(items[0].label);
                                return date.toLocaleDateString('es-ES', { 
                                    year: 'numeric', month: 'short', day: 'numeric' 
                                });
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            display: isExpanded, // Solo mostrar fechas si est치 expandido
                            maxTicksLimit: 8,
                            font: { size: 11 },
                            color: '#9CA3AF'
                        }
                    },
                    y: {
                        border: { display: false },
                        grid: { color: '#f3f4f6', drawBorder: false },
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) return currencyFmt.format(value/1000000) + 'M';
                                if (value >= 1000) return currencyFmt.format(value/1000) + 'k';
                                return currencyFmt.format(value);
                            },
                            font: { size: 11 },
                            color: '#9CA3AF'
                        }
                    }
                }
            }
        };
    }

    /**
     * Actualiza la UI con los datos proporcionados (sin fetch)
     * @param {object} data - Los datos del dashboard
     * @param {string} timeframe - El timeframe actual
     */
    function updateUI(data, timeframe) {
        // 1. Destruir y Crear Gr치fico Peque침o
        if (smallChartInstance) {
            smallChartInstance.destroy();
        }
        
        chartDataCache = data.chart_data; // Actualizar cach칠
        activeTimeframe = timeframe; // Actualizar estado activo
        
        const ctxSmall = document.getElementById('portfolioChart').getContext('2d');
        smallChartInstance = new Chart(ctxSmall, createChartConfig(
            ctxSmall, 
            data.chart_data.labels, 
            data.chart_data.values,
            false
        ));

        // 2. Actualizar Datos Num칠ricos
        
        // Ocultar loaders de KPIs
        document.getElementById('loader-portfolio').classList.add('hidden');
        document.getElementById('loader-total').classList.add('hidden');

        const elPortfolio = document.getElementById('val-portfolio');
        elPortfolio.innerText = currencyFmt.format(data.summary.portfolio_value);
        elPortfolio.classList.remove('hidden');

        const elTotal = document.getElementById('val-total');
        elTotal.innerText = currencyFmt.format(data.summary.total_capital);
        elTotal.classList.remove('hidden');
        
        // Actualizar sidebar
        document.getElementById('sidebar-portfolio').innerText = currencyFmt.format(data.summary.portfolio_value);
        const sidebarPnl = document.getElementById('sidebar-pnl');
        const pnlInfo = formatPnl(data.summary.pnl_pct);
        sidebarPnl.innerText = pnlInfo.text;
        sidebarPnl.className = `text-sm font-medium ${pnlInfo.colorClass}`;
        
        const elPnl = document.getElementById('val-pnl-pct');
        const pnlInfo2 = formatPnl(data.summary.pnl_pct);
        elPnl.innerText = pnlInfo2.text + ' Global';
        elPnl.className = `text-sm font-medium mt-1 ${pnlInfo2.colorClass}`;
        elPnl.classList.remove('hidden');

        // 3. Actualizar Tabla de Inversiones (Filas)
        for (const [holdingId, info] of Object.entries(data.holdings_updates)) {
            const priceCell = document.getElementById(`price-${holdingId}`);
            if (priceCell) {
                priceCell.innerText = currencyFmt.format(info.current_price);
                priceCell.classList.remove('text-gray-400', 'animate-pulse');
            }
            const gainCell = document.getElementById(`gain-${holdingId}`);
            if (gainCell) {
                const gainData = formatPnl(info.pct);
                gainCell.innerText = `${currencyFmt.format(info.gain)} (${gainData.text})`;
                gainCell.classList.remove('text-gray-400', 'animate-pulse');
                gainCell.className = `px-6 py-4 font-semibold ${gainData.colorClass}`;
            }
        }

        // Ocultar Loader del Gr치fico
        document.getElementById('chart-loader').classList.add('hidden');
        document.getElementById('chart-container').classList.remove('hidden');
    }

    /**
     * Hace el fetch de los datos y actualiza el gr치fico y los KPIs
     * @param {string} timeframe - El rango de tiempo a solicitar (e.g., '1D', 'Todo').
     */
    async function updateChartAndData(timeframe) {
        // Mostrar Loader
        document.getElementById('chart-container').classList.add('hidden');
        document.getElementById('chart-loader').classList.remove('hidden');

        try {
            const url = `${API_URL}?timeframe=${timeframe}`;
            const response = await fetch(url);
            const data = await response.json();

            if (data.error) {
                console.error("Error API:", data.error);
                throw new Error(data.error);
            }

            // Usar updateUI para actualizar
            updateUI(data, timeframe);

        } catch (err) {
            console.error("Fallo al actualizar datos del dashboard:", err);
            // Manejo de errores visuales si es necesario
        } finally {
            // Ocultar Loader del Gr치fico
            document.getElementById('chart-loader').classList.add('hidden');
            document.getElementById('chart-container').classList.remove('hidden');
        }
    }


    // --- Inicializaci칩n y Event Listeners ---
    document.addEventListener('DOMContentLoaded', function() {
        
        // 1. Cargar datos iniciales desde el servidor (sin fetch)
        updateUI(initialData, 'Todo');

        // 2. Configurar Listeners para los botones de rango de tiempo
        const buttons = document.querySelectorAll('.timeframe-btn');

        buttons.forEach(button => {
            button.addEventListener('click', function() {
                const timeframe = this.getAttribute('data-timeframe');
                
                // Desactivar todos los botones
                buttons.forEach(btn => {
                    btn.classList.remove('bg-simvest-blue', 'text-white', 'border-simvest-blue');
                    btn.classList.add('text-gray-500', 'bg-white', 'dark:bg-gray-700', 'dark:text-gray-300', 'border-gray-200', 'dark:border-gray-600', 'hover:bg-gray-100', 'dark:hover:bg-gray-600');
                });

                // Activar el bot칩n clicado
                this.classList.add('bg-simvest-blue', 'text-white', 'border-simvest-blue');
                this.classList.remove('text-gray-500', 'bg-white', 'dark:bg-gray-700', 'dark:text-gray-300', 'border-gray-200', 'dark:border-gray-600', 'hover:bg-gray-100', 'dark:hover:bg-gray-600');

                // Llamar a la funci칩n de actualizaci칩n de datos
                updateChartAndData(timeframe);
            });
        });
    });

    // Funci칩n para toggle del sidebar
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('hidden');
    }
</script>
  </main>
</div>
{% endblock %}