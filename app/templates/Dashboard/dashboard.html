{% extends "base.html" %}
{% block title %}Dashboard - Simvest{% endblock %}

{% block content %}
<main class="container mx-auto px-6 py-12 space-y-12">

    <section class="flex flex-col md:flex-row md:items-center md:justify-between 
                    bg-gradient-to-r from-simvest-blue to-simvest-darkblue 
                    text-white rounded-2xl shadow-lg p-8 relative overflow-hidden">
        <div class="z-10">
            <h1 class="text-4xl font-extrabold mb-2">
                Bienvenido, <span class="text-simvest-yellow">{{ current_user.username }}</span> ðŸ‘‹
            </h1>
            <p class="text-lg opacity-90">Gestiona tus inversiones, analiza tu portafolio y aprende del mercado.</p>
        </div>
    </section>

    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-simvest-gray mb-2">ðŸ’° Capital Disponible</h3>
            <p class="text-4xl font-bold text-simvest-blue">{{ current_capital | currency }}</p>
        </div>

        <div class="p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-simvest-gray mb-2">ðŸ“ˆ Valor del Portafolio</h3>
            <div id="loader-portfolio" class="animate-pulse h-8 w-32 bg-gray-200 rounded"></div>
            <p id="val-portfolio" class="text-4xl font-bold text-simvest-yellow hidden">$0.00</p>
            <p class="text-sm text-gray-500 mt-1">Valor de mercado actual</p>
        </div>

        <div class="p-6 bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-simvest-gray mb-2">ðŸ’¼ Capital Total</h3>
            <div id="loader-total" class="animate-pulse h-8 w-32 bg-gray-200 rounded"></div>
            <p id="val-total" class="text-4xl font-bold text-simvest-green hidden">$0.00</p>
            <p id="val-pnl-pct" class="text-sm font-medium mt-1 hidden">--%</p>
        </div>
    </section>
    
    <section class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-simvest-gray dark:text-gray-100 mb-4">ðŸ“Š EvoluciÃ³n del Portafolio</h2>
        
        <div id="chart-loader" class="flex justify-center items-center h-40">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-simvest-blue"></div>
            <span class="ml-3 text-gray-500">Calculando historial...</span>
        </div>
        
        <div id="chart-container" class="hidden">
            <canvas id="portfolioChart" class="w-full h-40"></canvas> 
        </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-100 dark:border-gray-700">
            <h2 class="text-2xl font-bold text-simvest-blue mb-4">ðŸ“œ Historial Reciente</h2>
            
            {% if transaction_history %}
            <div class="space-y-3">
                {% for t in transaction_history %}
                {% set is_sell = t.type == 'SELL' %}
                <div class="flex justify-between items-center p-3 rounded-lg border 
                            {% if is_sell %}bg-red-50 border-red-200{% else %}bg-green-50 border-green-200{% endif %}">
                    
                    <div class="flex items-center space-x-3">
                        <span class="text-xl {% if is_sell %}text-red-500{% else %}text-green-500{% endif %}">
                            {% if is_sell %}ðŸ”»{% else %}ðŸ”º{% endif %}
                        </span>
                        <div>
                            <p class="font-semibold text-gray-800 dark:text-gray-100">
                                {{ t.type }} {{ "{:,.2f}".format(t.quantity) }}x **{{ t.symbol }}**
                            </p>
                            <p class="text-xs text-gray-500">
                                {{ t.timestamp.strftime('%Y-%m-%d %H:%M') }}
                            </p>
                        </div>
                    </div>
                    
                    <p class="font-bold {% if is_sell %}text-red-600{% else %}text-green-600{% endif %}">
                        {{ (t.price_per_unit * t.quantity) | currency }}
                    </p>
                </div>
                {% endfor %}
            </div>
            <a href="{{ url_for('dashboard.history') }}" class="mt-4 inline-block text-simvest-blue hover:underline">
                Ver historial completo
            </a>
            {% else %}
            <p class="text-gray-500 italic">AÃºn no hay transacciones en tu historial.</p>
            {% endif %}
        </div>
        
        <div class="bg-simvest-blue/10 dark:bg-blue-900/50 p-6 rounded-2xl shadow-sm border border-simvest-blue/20">
            <h3 class="text-xl font-bold text-simvest-blue dark:text-blue-200 mb-3">ðŸŽ“ GuÃ­a de Simvest</h3>
            <p class="text-gray-700 dark:text-gray-300 mb-4">
                Â¿Eres nuevo? Aprende a usar la plataforma, a comprar acciones y a interpretar tu portafolio.
            </p>
            <a href="#" class="bg-simvest-blue hover:bg-simvest-darkblue text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                Aprender Ahora
            </a>
        </div>

    </section>

    <section class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-100 dark:border-gray-700">
        <h2 class="text-2xl font-bold text-simvest-blue mb-4">Mis Inversiones</h2>
        
        {% if holdings %}
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-left text-gray-700 dark:text-gray-300">
                <thead class="bg-gray-50 dark:bg-gray-700 text-gray-600 uppercase text-xs font-semibold">
                    <tr>
                        <th class="px-6 py-3">SÃ­mbolo</th>
                        <th class="px-6 py-3">Cantidad</th>
                        <th class="px-6 py-3">Compra</th>
                        <th class="px-6 py-3">Precio Actual</th>
                        <th class="px-6 py-3">Ganancia/PÃ©rdida</th>
                        <th class="px-6 py-3 text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for h in holdings %}
                    
                    <tr class="border-b hover:bg-gray-50 dark:hover:bg-gray-700 transition cursor-pointer group relative" 
                        id="row-{{ h.id }}"
                        onclick="window.location='{{ url_for('market.asset_detail', symbol=h.symbol) }}'">
                        
                        <td class="px-6 py-4 font-bold text-simvest-blue group-hover:underline">
                            {{ h.name }}
                        </td>
                        <td class="px-6 py-4">{{ "{:,.2f}".format(h.quantity) }}</td>
                        <td class="px-6 py-4">{{ h.purchase_price | currency }}</td>
                        
                        <td class="px-6 py-4">
                            <span id="price-{{ h.id }}" class="text-gray-400 animate-pulse">Cargando...</span>
                        </td>
                        <td class="px-6 py-4 font-semibold">
                            <span id="gain-{{ h.id }}" class="text-gray-400 animate-pulse">--</span>
                        </td>
                        
                        <td class="px-6 py-4 text-center">
                            <span class="font-mono text-sm font-semibold text-gray-800 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 px-3 py-1.5 rounded-lg">
                                {{ "{:,.4f}".format(h.quantity) }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <p class="text-gray-500 italic mb-2">AÃºn no tienes inversiones activas.</p>
            <a href="{{ url_for('market.index') }}" class="text-simvest-blue hover:underline text-sm">Ir al mercado para comprar</a>
        </div>
        {% endif %}
    </section>

</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. FunciÃ³n para formatear dinero en JS
    const currencyFmt = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2
    });

    // FunciÃ³n para formatear porcentaje con color
    function formatPnl(pnlVal) {
        const sign = pnlVal >= 0 ? '+' : '';
        const colorClass = pnlVal >= 0 ? 'text-green-600' : 'text-red-600';
        return {
            text: `${sign}${pnlVal.toFixed(2)}%`,
            colorClass: colorClass
        };
    }

    // 2. Llamada a la API
    fetch("{{ url_for('dashboard.dashboard_data') }}")
        .then(response => response.json())
        .then(data => {
            if (data.error) { console.error("Error del servidor API:", data.error); return; }

            // --- A. Actualizar Tarjetas Resumen ---
            
            // Ocultar loaders
            document.getElementById('loader-portfolio').classList.add('hidden');
            document.getElementById('loader-total').classList.add('hidden');
            
            // Valor Portafolio
            const elPortfolio = document.getElementById('val-portfolio');
            elPortfolio.innerText = currencyFmt.format(data.summary.portfolio_value);
            elPortfolio.classList.remove('hidden');

            // Capital Total
            const elTotal = document.getElementById('val-total');
            elTotal.innerText = currencyFmt.format(data.summary.total_capital);
            elTotal.classList.remove('hidden');
            
            // P&L Porcentaje Global (color coding)
            const elPnl = document.getElementById('val-pnl-pct');
            const pnlData = formatPnl(data.summary.pnl_pct);

            elPnl.innerText = pnlData.text + ' Global';
            elPnl.className = `text-sm font-medium mt-1 ${pnlData.colorClass}`;
            elPnl.classList.remove('hidden');


            // --- B. Actualizar Tabla de Inversiones ---
            for (const [holdingId, info] of Object.entries(data.holdings_updates)) {
                // Actualizar Precio Actual
                const priceCell = document.getElementById(`price-${holdingId}`);
                if (priceCell) {
                    priceCell.innerText = currencyFmt.format(info.current_price);
                    priceCell.classList.remove('text-gray-400', 'animate-pulse');
                }

                // Actualizar Ganancia/PÃ©rdida
                const gainCell = document.getElementById(`gain-${holdingId}`);
                if (gainCell) {
                    const gainData = formatPnl(info.pct); // Usar la funciÃ³n de formato para el porcentaje
                    
                    gainCell.innerText = `${currencyFmt.format(info.gain)} (${gainData.text})`;
                    gainCell.classList.remove('text-gray-400', 'animate-pulse');
                    gainCell.classList.add(gainData.colorClass); // Aplicar color
                }
            }


            // --- C. Renderizar GrÃ¡fico ---
            document.getElementById('chart-loader').classList.add('hidden');
            document.getElementById('chart-container').classList.remove('hidden');

            const ctx = document.getElementById('portfolioChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.chart_data.labels,
                    datasets: [{
                        label: 'Valor Total',
                        data: data.chart_data.values,
                        fill: true,
                        borderColor: '#2563EB',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Permitir que el h-40 de Tailwind funcione
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { display: false } }, // Ocultar leyenda
                    scales: {
                        y: { grid: { display: true, color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                }
            });

        })
        .catch(err => console.error("Error cargando datos dashboard (Frontend):", err));
});
</script>
{% endblock %}