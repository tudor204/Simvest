{% extends "base.html" %}

{% block styles %}
<style>
    /* Estilos para las Pestañas */
    .category-tab {
        color: #374151; /* text-gray-700 */
        background-color: transparent;
    }
    .category-tab:hover {
        background-color: #e5e7eb; /* bg-gray-200 */
    }
    .category-tab.active-tab {
        color: #ffffff; /* text-white */
        background-color: #2563eb; /* bg-blue-600 */
        font-weight: 600; /* semibold */
    }
    
    /* Nuevos estilos para las tarjetas clickables */
    .product-card {
        position: relative;
        transition: all 0.3s ease;
    }
    .product-card:hover {
        transform: translateY(-2px);
    }
    .details-indicator {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .product-card:hover .details-indicator {
        opacity: 1;
    }
</style>
{% endblock styles %}

{% block content %}

<div class="container mx-auto mt-10 p-5">
    
    <h1 class="text-3xl font-bold mb-6 text-gray-800">Mercado de Inversión</h1>
    
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-1 flex flex-col gap-6">
            
            <div class="bg-white p-6 rounded-xl shadow-xl border-t-4 border-blue-500">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">Tu Capital Disponible</h2>
                <p class="text-4xl font-extrabold text-blue-600" id="user-capital">${{ "{:,.2f}".format(current_user.capital) }}</p>
            </div>

            <div id="trade-form-card" class="bg-white p-6 rounded-xl shadow-xl sticky lg:top-6">
                <h2 id="trade-title" class="text-xl font-semibold mb-4 text-gray-700">Simular Compra</h2>
                <form method="POST" action="{{ url_for('market.market') }}">
                    <div class="mb-4">
                        <label for="trade-symbol" class="block text-sm font-medium text-gray-700">Símbolo</label>
                        <input type="text" id="trade-symbol" name="symbol" required 
                               class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-100"
                               placeholder="Selecciona un activo" readonly>
                    </div>
                    <div class="mb-4">
                        <label for="quantity" class="block text-sm font-medium text-gray-700">Cantidad</label>
                        <input type="number" id="quantity" name="quantity" required min="0.00001" step="any"
                               class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="0.00">
                    </div>
                    <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        Comprar
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-2">
            
            <div class="mb-5">
                <nav id="category-tabs" class="flex flex-wrap gap-2 p-2 bg-gray-100 rounded-xl shadow-inner">
                    <button data-category="all" class="category-tab active-tab text-sm font-medium px-4 py-2 rounded-lg transition-colors">Todos</button>
                    <button data-category="acciones" class="category-tab text-sm font-medium px-4 py-2 rounded-lg transition-colors">Acciones</button>
                    <button data-category="fondos" class="category-tab text-sm font-medium px-4 py-2 rounded-lg transition-colors">Fondos de Inversión</button>
                    <button data-category="etfs" class="category-tab text-sm font-medium px-4 py-2 rounded-lg transition-colors">ETFs</button>
                    <button data-category="renta-fija" class="category-tab text-sm font-medium px-4 py-2 rounded-lg transition-colors">Renta Fija</button>                    
                    <button data-category="crypto" class="category-tab text-sm font-medium px-4 py-2 rounded-lg transition-colors">Criptomonedas</button>
                </nav>
            </div>

            <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                {% for product in market_universe %}
                <div id="card-{{ product.symbol }}" 
                     class="product-card bg-white p-5 rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-shadow cursor-pointer group" 
                     data-symbol="{{ product.symbol }}"
                     data-category="{{ product.category }}"
                     onclick="window.location.href='{{ url_for('market.asset_detail', symbol=product.symbol) }}'">
                    
                    <!-- Indicador de detalles (aparece al hacer hover) -->
                    <div class="details-indicator absolute top-3 right-3">
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </div>
                    
                    <div class="flex justify-between items-start mb-3">
                        <div class="w-1/3 flex flex-col justify-start">
                            <h3 class="text-base font-bold text-gray-800 truncate">{{ product.name }}</h3>
                            <p class="text-sm text-gray-500 font-mono">{{ product.symbol }}</p>
                        </div>
                        
                        <div class="w-1/3 h-10 mx-2 flex items-center justify-center">
                            <canvas id="sparkline-{{ product.symbol }}"></canvas>
                        </div>

                        <div class="w-1/3 flex justify-end">
                            <span id="change-{{ product.symbol }}" 
                                  class="price-change-container text-xs font-semibold px-2 py-1 rounded-full bg-gray-200 text-gray-600 transition-colors duration-300">
                                Cargando...
                            </span>
                        </div>
                    </div>
                    
                    <p id="price-{{ product.symbol }}" class="text-3xl font-extrabold text-gray-900 price-container">
                        <svg class="animate-spin h-6 w-6 text-blue-500 inline mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </p>
                    
                    <div class="flex gap-2 mt-4">
                        <button class="buy-button flex-1 py-2 px-4 border border-blue-500 rounded-lg shadow-sm text-sm font-medium text-blue-600 bg-white hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 transition-colors"
                                data-symbol="{{ product.symbol }}"
                                data-name="{{ product.name }}"
                                onclick="event.stopPropagation()">
                            Comprar
                        </button>
                        <button class="details-button py-2 px-4 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors"
                                onclick="event.stopPropagation(); window.location.href='{{ url_for('market.asset_detail', symbol=product.symbol) }}'">
                            Detalles
                        </button>
                    </div>
                </div>
                {% endfor %}
                </div>
        </div>

    </div>
</div>

{% endblock content %}

{% block scripts %}
<script>
    // Almacenamiento de instancias de Chart para evitar duplicados
    const chartInstances = {};

    // --- FUNCIÓN DE DIBUJO DEL SPARKLINE ---
    function drawSparkline(symbol, history, trendColor) {
        const ctx = document.getElementById('sparkline-' + symbol);
        
        // El condicional Chart verifica si Chart.js se cargó correctamente en base.html
        if (ctx && typeof Chart !== 'undefined') {
            
            // Destruir la instancia anterior si existe (evita errores al recargar la data)
            if (chartInstances[symbol]) {
                chartInstances[symbol].destroy();
            }

            const priceData = history; 
            const labels = Array(priceData.length).fill('');
            
            // Configuración de Chart.js para un Sparkline
            chartInstances[symbol] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: priceData,
                        borderColor: trendColor,
                        borderWidth: 1.5,
                        fill: false, 
                        tension: 0.2, // Ligero suavizado de la línea
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false } 
                    },
                    scales: {
                        x: { display: false }, 
                        y: { display: false } 
                    },
                    elements: {
                        point: { radius: 0 } 
                    },
                    layout: {
                        padding: 0
                    }
                }
            });
        }
    }

    // --- FUNCIÓN DE CARGA ASÍNCRONA DE PRECIOS REALES CON GRÁFICOS ---
    function fetchAndRenderLiveData() {
        // Llama a la ruta que retorna los datos en tiempo real (incluyendo 'history')
        const liveDataUrl = '{{ url_for("market.get_live_market_data") }}'; 
        
        fetch(liveDataUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Iterar sobre los datos recibidos y actualizar las tarjetas
                data.forEach(item => {
                    const priceContainer = document.getElementById('price-' + item.symbol);
                    const changeContainer = document.getElementById('change-' + item.symbol);
                    
                    // 1. Actualización de Precio y Cambio
                    if (priceContainer) {
                        priceContainer.innerHTML = '$' + item.price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    }

                    if (changeContainer) {
                        changeContainer.textContent = item.change;
                        
                        // Remover clases antiguas
                        changeContainer.classList.remove('bg-gray-200', 'text-gray-600', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
                        
                        let trendColor;
                        // Añadir clases nuevas basadas en el cambio
                        if (item.change.startsWith('+')) {
                            changeContainer.classList.add('bg-green-100', 'text-green-800');
                            trendColor = '#10B981'; // green-500
                        } else if (item.change.startsWith('-')) {
                            changeContainer.classList.add('bg-red-100', 'text-red-800');
                            trendColor = '#EF4444'; // red-500
                        } else {
                            changeContainer.classList.add('bg-gray-200', 'text-gray-600');
                            trendColor = '#6B7280'; // gray-500
                        }

                        // 2. Dibujar el Sparkline
                        if (item.history && item.history.length > 1) {
                            drawSparkline(item.symbol, item.history, trendColor);
                        } else if (item.history && item.history.length === 1) {
                            // Si solo hay un punto, simplemente no dibujamos la línea
                            console.log(`Datos insuficientes para sparkline de ${item.symbol}.`);
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error al obtener datos en tiempo real:', error);
                const errorElements = document.querySelectorAll('.price-container');
                errorElements.forEach(el => {
                    el.innerHTML = '<span class="text-sm text-red-500">Error de conexión</span>';
                });
            });
    }
    
    // El script se ejecuta cuando el DOM está listo
    document.addEventListener('DOMContentLoaded', function() {
        
        // 💡 1. INICIAR LA CARGA DE DATOS ASÍNCRONA
        fetchAndRenderLiveData();
        
        // Configurar la recarga automática cada 30 segundos (simulación de tiempo real)
        setInterval(fetchAndRenderLiveData, 30000); 

        // --- Lógica de Filtrado por Pestañas ---
        const tabs = document.querySelectorAll('.category-tab');
        const products = document.querySelectorAll('.product-card');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const category = tab.getAttribute('data-category');

                tabs.forEach(t => t.classList.remove('active-tab'));
                tab.classList.add('active-tab');

                products.forEach(product => {
                    if (category === 'all' || product.getAttribute('data-category') === category) {
                        product.style.display = 'block';
                    } else {
                        product.style.display = 'none';
                    }
                });
            });
        });

        // Activar la pestaña "Todos" por defecto
        document.querySelector('.category-tab[data-category="all"]').click();

        // --- Lógica de Autocompletar Formulario ---
        const buyButtons = document.querySelectorAll('.buy-button');
        const tradeTitle = document.getElementById('trade-title');
        const tradeSymbolInput = document.getElementById('trade-symbol');
        const tradeFormCard = document.getElementById('trade-form-card');
        const quantityInput = document.getElementById('quantity');


        buyButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                // Prevenir que el click se propague a la tarjeta
                event.stopPropagation();
                
                const symbol = button.getAttribute('data-symbol');
                const name = button.getAttribute('data-name');

                // Autocompletar el formulario
                tradeTitle.textContent = `Comprar: ${name} (${symbol})`;
                tradeSymbolInput.value = symbol;

                // Resetear la cantidad y poner el foco
                quantityInput.value = "";
                quantityInput.focus();

                // Opcional: Hacer scroll al formulario (útil en móviles)
                tradeFormCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            });
        });

        // --- Navegación por teclado para accesibilidad ---
        document.querySelectorAll('.product-card').forEach(card => {
            card.addEventListener('keypress', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    const symbol = card.getAttribute('data-symbol');
                    window.location.href = '{{ url_for("market.asset_detail", symbol="") }}' + symbol;
                }
            });
            
            // Hacer la tarjeta enfocable para accesibilidad
            card.setAttribute('tabindex', '0');
        });

    });
    
</script>
{% endblock scripts %}