<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simvest Pro | Plataforma de Inversi√≥n Profesional</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  {% block styles %}{% endblock %}

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            simvest: {
              blue: '#2563EB',
              lightblue: '#3B82F6',
              darkblue: '#1E40AF',
              green: '#16A34A',
              darkgreen: '#065F46',
              red: '#DC2626',
              yellow: '#FACC15',
              purple: '#7C3AED',
              gray: '#1F2937',
              lightgray: '#E5E7EB',
              bg: '#F9FAFB',
              darkbg: '#0F172A',
            },
          },
        },
      },
      darkMode: 'media',
    }
  </script>

  <style>
    body {
      padding-top: 5rem; /* Ajustado para que no tape contenido */
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Sidebar fixed - solo se aplica en screens grandes */
    @media (min-width: 1024px) {
      body.with-sidebar {
        padding-left: 16rem; /* 64 * 0.25 = 16rem = 256px */
      }
    }
    
    /* M√≥viles */
    @media (max-width: 1023px) {
      #sidebar {
        display: block !important;
      }
      #sidebar.-translate-x-full {
        transform: translateX(-100%);
      }
      #sidebar.show-mobile {
        transform: translateX(0);
      }
      #sidebar-overlay.show-overlay {
        display: block !important;
      }
    }
    
    main { flex: 1; }
    
    /* Animaci√≥n suave para el dropdown */
    .dropdown-enter {
      transform-origin: top right;
      transition: transform 0.1s ease-out, opacity 0.1s ease-out;
    }
    .hidden-menu { display: none; }

    /* ===== ESTILOS DEL CHAT FLOTANTE ===== */
    #ai-chat-widget {
      font-family: 'Inter', sans-serif;
    }

    #chat-toggle-btn {
      border: none;
      outline: none;
      cursor: pointer;
    }

    #chat-toggle-btn:hover {
      box-shadow: 0 20px 25px rgba(37, 99, 235, 0.4);
    }

    #chat-window {
      animation: slideUp 0.3s ease-out;
    }

    #chat-window.hidden {
      animation: slideDown 0.3s ease-out forwards;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideDown {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(20px);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.2s ease-out;
    }

    /* Scroll del chat */
    #chat-messages {
      scroll-behavior: smooth;
    }

    #chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    #chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    #chat-messages::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 3px;
    }

    #chat-messages::-webkit-scrollbar-thumb:hover {
      background: #999;
    }

    .dark #chat-messages::-webkit-scrollbar-thumb {
      background: #555;
    }

    .dark #chat-messages::-webkit-scrollbar-thumb:hover {
      background: #777;
    }

    /* MEJORAS AVANZADAS PARA EL CHAT */
    .chat-suggestion-btn {
      @apply text-xs p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-300 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-colors cursor-pointer border border-blue-200 dark:border-blue-700;
    }

    .chat-message-content {
      animation: messageSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .typing-dot {
      animation: typingAnimation 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingAnimation {
      0%, 60%, 100% {
        opacity: 0.5;
        transform: translateY(0);
      }
      30% {
        opacity: 1;
        transform: translateY(-8px);
      }
    }

    .chat-badge {
      display: inline-block;
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 6px;
    }

    @keyframes widgetPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(37, 99, 235, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
      }
    }

    #chat-toggle-btn.has-suggestions {
      animation: widgetPulse 2s infinite;
    }
  </style>
</head>

<body class="font-['Inter'] text-simvest-gray bg-simvest-bg dark:bg-simvest-darkbg dark:text-gray-100 transition-colors duration-300 with-sidebar">

  {% if current_user.is_authenticated %}
    {% include 'components/sidebar.html' %}
  {% endif %}

  <header class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-md shadow-sm fixed w-full top-0 z-50 border-b border-gray-200 dark:border-gray-700 transition-colors duration-300">
    <div class="container mx-auto flex justify-between items-center px-6 py-3">
      
      {% if current_user.is_authenticated %}
      <button onclick="toggleSidebar()" class="lg:hidden mr-4 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
        <i class="fas fa-bars text-xl text-gray-600 dark:text-gray-300"></i>
      </button>
      {% endif %}

      <a href="{{ url_for('dashboard.dashboard') }}" class="flex items-center gap-2 group">
        <div class="w-8 h-8 bg-simvest-blue text-white flex items-center justify-center rounded-lg shadow-lg group-hover:rotate-12 transition-transform">
            <i class="fa-solid fa-chart-line"></i>
        </div>
        <span class="text-2xl font-extrabold tracking-tight text-simvest-blue dark:text-simvest-lightblue">
          Simvest Pro
        </span>
      </a>

      {% if current_user.is_authenticated %}
      <nav class="hidden md:flex items-center space-x-8">
          <a href="{{ url_for('dashboard.dashboard') }}" 
             class="text-sm font-semibold transition-colors duration-200 
             {% if request.endpoint == 'dashboard.dashboard' %} text-simvest-blue dark:text-simvest-lightblue {% else %} text-gray-600 hover:text-simvest-blue dark:text-gray-400 dark:hover:text-white {% endif %}">
             <i class="fa-solid fa-house mr-1"></i> Dashboard
          </a>

          <a href="{{ url_for('market.market') }}" 
             class="text-sm font-semibold transition-colors duration-200
             {% if request.endpoint == 'market.market' %} text-simvest-blue dark:text-simvest-lightblue {% else %} text-gray-600 hover:text-simvest-blue dark:text-gray-400 dark:hover:text-white {% endif %}">
             <i class="fa-solid fa-globe mr-1"></i> Mercado
          </a>
      </nav>
      {% endif %}

      <div class="flex items-center gap-4">
        {% if current_user.is_authenticated %}
          
          <div class="relative ml-3">
            <div>
              <button type="button" onclick="toggleDropdown()" class="flex items-center gap-2 max-w-xs bg-white dark:bg-gray-800 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-simvest-blue" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
                <span class="sr-only">Abrir men√∫</span>
                
                <span class="hidden md:block text-sm font-medium text-gray-700 dark:text-gray-200 mr-1">
                    {{ current_user.username }}
                </span>

                {% if current_user.profile_picture %}
                    <img class="h-9 w-9 rounded-full object-cover border border-gray-200 dark:border-gray-600" src="{{ url_for('static', filename='uploads/' + current_user.profile_picture) }}" alt="">
                {% else %}
                    <div class="h-9 w-9 rounded-full bg-simvest-blue text-white flex items-center justify-center font-bold shadow-md">
                        {{ current_user.username[0] | upper }}
                    </div>
                {% endif %}
                
                <i class="fa-solid fa-chevron-down text-xs text-gray-400"></i>
              </button>
            </div>

            <div id="user-menu" class="hidden-menu origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white dark:bg-gray-700 ring-1 ring-black ring-opacity-5 focus:outline-none dropdown-enter" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1">
              <div class="px-4 py-2 border-b border-gray-100 dark:border-gray-600 md:hidden">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Conectado como</p>
                  <p class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ current_user.username }}</p>
              </div>
              
              <a href="{{ url_for('profile.profile') }}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem">
                  <i class="fa-regular fa-user w-5"></i> Mi Perfil
              </a>
              <a href="{{ url_for('profile.edit_profile') }}" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600" role="menuitem">
                  <i class="fa-solid fa-gear w-5"></i> Configuraci√≥n
              </a>
              
              <div class="md:hidden border-t border-gray-100 dark:border-gray-600">
                  <a href="{{ url_for('dashboard.dashboard') }}" class="block px-4 py-2 text-sm text-simvest-blue dark:text-simvest-lightblue" role="menuitem">Dashboard</a>
                  <a href="{{ url_for('market.market') }}" class="block px-4 py-2 text-sm text-simvest-blue dark:text-simvest-lightblue" role="menuitem">Mercado</a>
              </div>

              <div class="border-t border-gray-100 dark:border-gray-600"></div>
              
              <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20" role="menuitem">
                  <i class="fa-solid fa-arrow-right-from-bracket w-5"></i> Cerrar Sesi√≥n
              </a>
            </div>
          </div>

        {% else %}
          <div class="flex items-center gap-3">
              <a href="{{ url_for('login') }}" class="text-sm font-semibold text-gray-600 hover:text-simvest-blue dark:text-gray-300 dark:hover:text-white transition hidden sm:block">
                Iniciar Sesi√≥n
              </a>
              <a href="{{ url_for('register') }}" class="bg-simvest-blue hover:bg-simvest-darkblue text-white text-sm font-bold px-5 py-2.5 rounded-full shadow-lg shadow-blue-500/30 transition-all transform hover:scale-105">
                Registrarse
              </a>
          </div>
        {% endif %}
      </div>
    </div>
  </header>

  <div class="fixed top-24 right-6 space-y-3 z-50 pointer-events-none"> <div class="container mx-auto px-6 flex flex-col items-end pointer-events-auto">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            {% set base = 'px-4 py-3 rounded-lg shadow-xl font-medium animate-slideIn border flex items-center gap-3 min-w-[300px] bg-white dark:bg-gray-800' %}
            
            {% if category == 'success' %}
              <div class="{{ base }} border-l-4 border-simvest-green text-gray-700 dark:text-gray-200">
                <div class="text-simvest-green"><i class="fa-solid fa-circle-check fa-lg"></i></div>
                <div>{{ message }}</div>
              </div>
            {% elif category == 'error' or category == 'danger' %}
              <div class="{{ base }} border-l-4 border-simvest-red text-gray-700 dark:text-gray-200">
                <div class="text-simvest-red"><i class="fa-solid fa-circle-exclamation fa-lg"></i></div>
                <div>{{ message }}</div>
              </div>
            {% else %}
              <div class="{{ base }} border-l-4 border-simvest-blue text-gray-700 dark:text-gray-200">
                <div class="text-simvest-blue"><i class="fa-solid fa-circle-info fa-lg"></i></div>
                <div>{{ message }}</div>
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>
  </div>

  <main data-aos="fade-up" data-aos-delay="50" class="flex-1">
    {% block content %}{% endblock %}
  </main>

  <footer class="bg-white border-t border-gray-200 dark:bg-simvest-darkbg dark:border-gray-800 text-gray-600 dark:text-gray-400 py-8 mt-auto">
    <div class="container mx-auto px-6 text-center">
      <p class="text-sm">&copy; 2025 <span class="font-bold text-simvest-blue">Simvest Pro</span>. Plataforma profesional de simulaci√≥n financiera.</p>
    </div>
  </footer>

  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

  <script>
    AOS.init({ duration: 800, once: true });

    // üü¢ L√≥gica para el Dropdown del Usuario
    function toggleDropdown() {
        const menu = document.getElementById('user-menu');
        if (menu.classList.contains('hidden-menu')) {
            menu.classList.remove('hidden-menu');
            // Animaci√≥n simple de entrada
            menu.style.opacity = "0";
            menu.style.transform = "scale(0.95)";
            setTimeout(() => {
                menu.style.opacity = "1";
                menu.style.transform = "scale(1)";
            }, 10);
        } else {
            menu.classList.add('hidden-menu');
        }
    }

    // Cerrar el dropdown si se hace click fuera
    window.onclick = function(event) {
        const button = document.getElementById('user-menu-button');
        const menu = document.getElementById('user-menu');
        if (button && !button.contains(event.target) && !menu.contains(event.target)) {
            menu.classList.add('hidden-menu');
        }
    }

    // üü¢ Toggle del Sidebar en m√≥viles
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        if (sidebar) {
            sidebar.classList.toggle('show-mobile');
            sidebar.classList.toggle('-translate-x-full');
        }
        if (overlay) {
            overlay.classList.toggle('show-overlay');
        }
    }
  </script>

  <!-- Chat de IA Flotante MEJORADO (Solo para usuarios autenticados) -->
  {% if current_user.is_authenticated %}
  <div id="ai-chat-widget" class="fixed bottom-6 right-6 z-50">
    <!-- Bot√≥n flotante con tooltip -->
    <button id="chat-toggle-btn" class="w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-gradient-to-br from-simvest-blue to-simvest-darkblue text-white shadow-2xl hover:shadow-3xl transform hover:scale-110 transition-all duration-300 flex items-center justify-center cursor-pointer relative group">
      <i class="fas fa-comments text-xl sm:text-2xl"></i>
      <span class="absolute top-0 right-0 w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
      <div class="absolute -top-12 right-0 bg-gray-900 text-white text-xs px-3 py-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
        üí¨ Asistente IA
      </div>
    </button>

    <!-- Ventana de chat premium -->
    <div id="chat-window" class="absolute bottom-20 sm:bottom-24 right-0 w-80 sm:w-96 h-[32rem] sm:h-[28rem] bg-white dark:bg-gray-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-gray-200 dark:border-gray-700 hidden transition-all duration-300">
      
      <!-- Header mejorado -->
      <div class="bg-gradient-to-r from-simvest-blue to-simvest-darkblue text-white p-4 flex justify-between items-center flex-shrink-0">
        <div>
          <h3 class="font-bold text-lg">ü§ñ Asistente Inteligente</h3>
          <p class="text-xs opacity-90">Respuestas sobre inversi√≥n</p>
        </div>
        <button id="chat-close-btn" class="hover:bg-white/20 p-2 rounded-lg transition-colors">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>

      <!-- √Årea de mensajes con gradiente -->
      <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-gray-50 to-gray-100 dark:from-gray-900 dark:to-gray-800">
        <div class="flex justify-start chat-message-content">
          <div class="bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 p-3 rounded-lg rounded-tl-none max-w-xs shadow-sm text-sm">
            <span class="chat-badge">INICIO</span>
            ¬°Hola! üëã Soy tu asistente de inversi√≥n. Puedo explicarte sobre t√©rminos financieros, estrategias de inversi√≥n, y mucho m√°s. ¬øQu√© deseas aprender?
          </div>
        </div>
      </div>

      <!-- Sugerencias din√°micas -->
      <div id="chat-suggestions" class="px-4 py-3 border-t border-gray-200 dark:border-gray-700 flex flex-col gap-2 max-h-24 overflow-y-auto bg-white dark:bg-gray-800">
        <div class="text-xs font-semibold text-gray-600 dark:text-gray-400">Preguntas sugeridas:</div>
        <div class="grid grid-cols-2 gap-2">
          <button class="suggestion-btn chat-suggestion-btn text-left" data-question="¬øQu√© es una acci√≥n?">
            <i class="fas fa-chart-line text-xs mr-1"></i> Acciones
          </button>
          <button class="suggestion-btn chat-suggestion-btn text-left" data-question="¬øC√≥mo empiezo a invertir?">
            <i class="fas fa-play-circle text-xs mr-1"></i> Empezar
          </button>
          <button class="suggestion-btn chat-suggestion-btn text-left" data-question="¬øQu√© es diversificaci√≥n?">
            <i class="fas fa-shuffle text-xs mr-1"></i> Diversificar
          </button>
          <button class="suggestion-btn chat-suggestion-btn text-left" data-question="¬øQu√© es un ETF?">
            <i class="fas fa-box text-xs mr-1"></i> ETF
          </button>
        </div>
      </div>

      <!-- Input mejorado con validaci√≥n -->
      <div class="border-t border-gray-200 dark:border-gray-700 p-3 sm:p-4 bg-white dark:bg-gray-800 flex-shrink-0">
        <form id="chat-form" class="flex gap-2">
          <input 
            id="chat-input" 
            type="text" 
            placeholder="Pregunta sobre inversi√≥n..."
            class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-simvest-blue placeholder-gray-500 dark:placeholder-gray-400 text-sm transition-all"
            autocomplete="off"
            maxlength="200"
          />
          <button 
            type="submit"
            class="bg-simvest-blue hover:bg-simvest-darkblue text-white px-4 py-2 rounded-lg transition-all transform hover:scale-105 active:scale-95 font-medium"
            title="Enviar pregunta (Enter)"
          >
            <i class="fas fa-send text-sm"></i>
          </button>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <script>
  // ===== Chat de IA MEJORADO (Disponible en todas las p√°ginas) =====
  document.addEventListener('DOMContentLoaded', function() {
    const chatToggleBtn = document.getElementById('chat-toggle-btn');
    const chatWindow = document.getElementById('chat-window');
    const chatCloseBtn = document.getElementById('chat-close-btn');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const chatMessages = document.getElementById('chat-messages');
    const chatSuggestions = document.getElementById('chat-suggestions');

    if (!chatToggleBtn) return;

    // Toggle chat window
    chatToggleBtn.addEventListener('click', function() {
      chatWindow.classList.toggle('hidden');
      chatInput.focus();
    });

    chatCloseBtn.addEventListener('click', function() {
      chatWindow.classList.add('hidden');
    });

    // Manejar click en sugerencias iniciales
    document.querySelectorAll('.suggestion-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const question = this.dataset.question;
        chatInput.value = question;
        chatForm.dispatchEvent(new Event('submit'));
      });
    });

    // Actualizar sugerencias despu√©s de cada respuesta
    function updateSuggestions(suggestions) {
      if (!suggestions || suggestions.length === 0) return;
      
      chatSuggestions.innerHTML = '<div class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2">Siguientes preguntas:</div>';
      const suggestionContainer = document.createElement('div');
      suggestionContainer.className = 'grid grid-cols-2 gap-2';
      
      suggestions.slice(0, 4).forEach(suggestion => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'suggestion-btn chat-suggestion-btn text-left';
        btn.textContent = suggestion;
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          chatInput.value = suggestion;
          chatForm.dispatchEvent(new Event('submit'));
        });
        suggestionContainer.appendChild(btn);
      });
      
      chatSuggestions.appendChild(suggestionContainer);
    }

    // Enviar mensaje
    chatForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const message = chatInput.value.trim();
      if (!message) return;

      addMessage(message, 'user');
      chatInput.value = '';
      chatInput.focus();

      showTypingIndicator();

      try {
        const response = await fetch('{{ url_for("training.training_chat") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: message })
        });

        const data = await response.json();
        removeTypingIndicator();
        
        if (data.success) {
          setTimeout(() => {
            addMessage(data.response, 'ai');
            // Actualizar sugerencias con las devueltas por el servidor
            if (data.suggestions) {
              updateSuggestions(data.suggestions);
            }
          }, 300);
        } else {
          addMessage('‚ùå Hubo un error. Por favor, intenta de nuevo.', 'ai');
        }
      } catch (error) {
        console.error('Error:', error);
        removeTypingIndicator();
        addMessage('‚ùå Error de conexi√≥n. Intenta m√°s tarde.', 'ai');
      }
    });

    // Indicador de escritura mejorado
    function showTypingIndicator() {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('flex', 'justify-start', 'chat-message-content');
      messageDiv.id = 'typing-indicator';

      const messageBubble = document.createElement('div');
      messageBubble.classList.add(
        'p-3',
        'rounded-lg',
        'rounded-tl-none',
        'bg-white',
        'dark:bg-gray-700',
        'shadow-sm',
        'flex',
        'gap-1',
        'items-center'
      );

      messageBubble.innerHTML = `
        <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
        <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
        <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
      `;

      messageDiv.appendChild(messageBubble);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Remover indicador de escritura
    function removeTypingIndicator() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) {
        indicator.remove();
      }
    }

    // A√±adir mensaje mejorado
    function addMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('flex', sender === 'user' ? 'justify-end' : 'justify-start', 'chat-message-content');

      const messageBubble = document.createElement('div');
      messageBubble.classList.add(
        'p-3',
        'rounded-lg',
        'max-w-xs',
        'shadow-sm',
        'text-sm',
        'break-words',
        'line-clamp-5'
      );

      if (sender === 'user') {
        messageBubble.classList.add(
          'bg-simvest-blue',
          'text-white',
          'rounded-br-none'
        );
      } else {
        messageBubble.classList.add(
          'bg-white',
          'dark:bg-gray-700',
          'text-gray-800',
          'dark:text-gray-200',
          'rounded-tl-none'
        );
      }

      messageBubble.textContent = text;
      messageDiv.appendChild(messageBubble);
      chatMessages.appendChild(messageDiv);

      // Auto scroll
      setTimeout(() => {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }, 0);
    }

    // Focus en el input al abrir el chat
    chatWindow.addEventListener('transitionend', function() {
      if (!chatWindow.classList.contains('hidden')) {
        chatInput.focus();
      }
    });
  });
  </script>
</body>
</html>